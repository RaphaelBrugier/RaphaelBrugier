<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Testing strategy for Apache Spark jobs – Part 1 of 2</title>

  <meta name="author" content="" />
  <meta name="keywords" content="">

  

  <meta name="generator" content="Hugo 0.68.3" />

  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/go.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/scala.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/dockerfile.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <script>window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);

    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };

    return t;
  }(document, "script", "twitter-wjs"));</script>

  
  <link href="https://www.raphael-brugier.com/css/animate.css" rel="stylesheet">

  
  
    <link href="https://www.raphael-brugier.com/css/style.default.css" rel="stylesheet" id="theme-stylesheet">
  


  
  <link href="https://www.raphael-brugier.com/css/custom.css" rel="stylesheet">

  
    

  
  <link rel="shortcut icon" href="https://www.raphael-brugier.com/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://www.raphael-brugier.com/img/apple-touch-icon.png" />
  

  <link href="https://www.raphael-brugier.com/css/owl.carousel.css" rel="stylesheet">
  <link href="https://www.raphael-brugier.com/css/owl.theme.css" rel="stylesheet">

  <link rel="alternate" href="https://www.raphael-brugier.com/index.xml" type="application/rss+xml" title="Raphael Brugier">

  
  <meta property="og:title" content="Testing strategy for Apache Spark jobs – Part 1 of 2" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.raphael-brugier.com/blog/testing-strategy-for-apache-spark-jobs-1-of-2//" />
  <meta property="og:image" content="" />

</head>


  <body>

    <div id="all">

        <header>

          <div class="navbar-affixed-top" data-spy="affix" data-offset-top="200">

    <div class="navbar navbar-default yamm" role="navigation" id="navbar">

        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="https://www.raphael-brugier.com/">
                  <h3>Raphael Brugier</h3>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                        <span class="sr-only">Toggle navigation</span>
                        <i class="fa fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li class="dropdown">
                        <a href="/about/">About</a>
                    </li>
                    

                    
                    <li class="dropdown">
                      <a href="https://twitter.com/rbrugier">
                        <i class="fa fa-twitter fa-2x" aria-hidden="true"></i>
                      </a>
                    </li>
                    
                    <li class="dropdown">
                      <a href="https://www.linkedin.com/in/raphaelbrugier">
                        <i class="fa fa-linkedin fa-2x" aria-hidden="true"></i>
                      </a>
                    </li>
                    
                    <li class="dropdown">
                      <a href="https://github.com/RaphaelBrugier">
                        <i class="fa fa-github fa-2x" aria-hidden="true"></i>
                      </a>
                    </li>
                    
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">

                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">

                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>

                </span>
                    </div>
                </form>

            </div>
            

        </div>
    </div>
    

</div>




        </header>

        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Testing strategy for Apache Spark jobs – Part 1 of 2</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">

                <div class="row">

                    

                    <div class="col-md-9" id="blog-post">

                        <p class="text-muted text-uppercase mb-small text-right">March 12, 2016</p>

                        <div id="post-content">
                          <p>Like any other application, Apache Spark jobs deserve good testing practices and coverage.</p>
<p>Indeed, the costs of running jobs with production data makes unit testing a must-do to have a fast feedback loop and discover the errors earlier.</p>
<p>But because of its distributed nature and the RDD abstraction on top of the data, Spark requires special care for testing.</p>
<p>In this post, we’ll explore how to design your code for testing, how to setup a simple unit-test for your job logic and how the <a href="https://github.com/holdenk/spark-testing-base">spark-testing-base</a> library can help.</p>
<h1 id="design-for-testing">Design for testing</h1>
<p>From a higher point of view, any Spark job can be described as an “immutable” a transformation of distributed data.</p>
<p>In particular, any Spark job can be refactored to a composition of functions taking data as input, the so-called RDD, and returning data, hence a RDD again.</p>
<p>Extracting the logic of the job into functions will make it possible to reuse the functions across different jobs and to isolate the behavior to test it in a deterministic environment.</p>
<p>To separate the logic from the scheduling and configuration of the job, you will also want to isolate the logic to a separated object.</p>
<p>Let’s apply this pattern to the well-known word count example.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">package</span> com.ipponusa
<span style="color:#66d9ef">import</span> org.apache.spark.<span style="color:#f92672">{</span><span style="color:#a6e22e">SparkConf</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">SparkContext</span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Main</span> <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">val</span> sparkConf <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SparkConf</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">.</span>setMaster<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;local[*]&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>setAppName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;spark-testing-example&#34;</span><span style="color:#f92672">)</span>
  <span style="color:#66d9ef">val</span> sc <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SparkContext</span><span style="color:#f92672">(</span>sparkConf<span style="color:#f92672">)</span>

  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> countByWordRdd <span style="color:#66d9ef">=</span>  sc<span style="color:#f92672">.</span>textFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;src/main/resources/intro.txt&#34;</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>flatMap<span style="color:#f92672">(</span>l <span style="color:#66d9ef">=&gt;</span> l<span style="color:#f92672">.</span>split<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\W+&#34;</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>word <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">.</span>reduceByKey<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">)</span>

    countByWordRdd<span style="color:#f92672">.</span>foreach<span style="color:#f92672">(</span>println<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Extracting a method is a <a href="http://refactoring.com/catalog/extractMethod.html">classic refactoring pattern</a>. Therefore, this can be easily done with a few keystrokes within your favorite IDE:</p>
<ol>
<li>Extract the input data in a separated variable to separate it from the logic</li>
<li>Extract the logic in a count method (select + refactor -&gt; extract -&gt; method)</li>
<li>Move the method to a new object, WordCounter</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">package</span> com.ipponusa
<span style="color:#66d9ef">import</span> org.apache.spark.rdd.RDD
<span style="color:#66d9ef">import</span> org.apache.spark.<span style="color:#f92672">{</span><span style="color:#a6e22e">SparkConf</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">SparkContext</span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Main</span> <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">val</span> sparkConf <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SparkConf</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">.</span>setMaster<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;local[*]&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>setAppName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;spark-testing-example&#34;</span><span style="color:#f92672">)</span>
  <span style="color:#66d9ef">val</span> sc <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SparkContext</span><span style="color:#f92672">(</span>sparkConf<span style="color:#f92672">)</span>

  <span style="color:#66d9ef">def</span> main<span style="color:#f92672">(</span>args<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> input<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>textFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;src/main/resources/intro.txt&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">val</span> countByWordRdd<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">WordCounter</span><span style="color:#f92672">.</span>count<span style="color:#f92672">(</span>input<span style="color:#f92672">)</span>

    countByWordRdd<span style="color:#f92672">.</span>foreach<span style="color:#f92672">(</span>println<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">package</span> com.ipponusa
<span style="color:#66d9ef">import</span> org.apache.spark.rdd.RDD

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">WordCounter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">def</span> count<span style="color:#f92672">(</span>lines<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> wordsCount <span style="color:#66d9ef">=</span> lines<span style="color:#f92672">.</span>flatMap<span style="color:#f92672">(</span>l <span style="color:#66d9ef">=&gt;</span> l<span style="color:#f92672">.</span>split<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\W+&#34;</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>word <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">))</span>
      <span style="color:#f92672">.</span>reduceByKey<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">)</span>
    wordsCount
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h1 id="basic-test">Basic test</h1>
<p>Now that we have extracted the logic, we can write a test assuming an input data and asserting the result of the function to an expected data. We will use <a href="http://www.scalatest.org/">ScalaTest</a> as a testing framework.</p>
<p>The tricky part when writing tests for Spark is the RDD abstraction. Your first idea would probably be to mock the input and the expected. But then, you will not be able to execute the Spark behavior on the RDD passed to the function.</p>
<p>Instead, we have to start a <code>SparkContext</code> to build the input and expected RDDs and run the transformation in a real Spark environment. Indeed, creating a <code>SparkContext</code> for unit testing is the <a href="http://spark.apache.org/docs/latest/programming-guide.html#unit-testing">recommended approach</a>.</p>
<p>Because starting a <code>SparkContext</code> is time-consuming, you will save a lot of time starting the context only once before all the tests. Also, even if it possible with some tweaking, it is not recommended to have more than one <code>SparkContext</code> living in the JVM. So make sure you stop the context after running all the tests and to disable the parallel execution.</p>
<p>Starting and stopping the <code>SparkContext</code> can easily be done with the <code>BeforeAndAfter</code> trait.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">package</span> com.ipponusa
<span style="color:#66d9ef">import</span> org.apache.spark.rdd.RDD
<span style="color:#66d9ef">import</span> org.apache.spark.<span style="color:#f92672">{</span><span style="color:#a6e22e">SparkConf</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">SparkContext</span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">import</span> org.scalatest.<span style="color:#f92672">{</span><span style="color:#a6e22e">BeforeAndAfter</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">FlatSpec</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Matchers</span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WordCounterTest</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">FlatSpec</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Matchers</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">BeforeAndAfter</span> <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">var</span> sc<span style="color:#66d9ef">:</span><span style="color:#66d9ef">SparkContext</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">_</span>

  before <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> sparkConf <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SparkConf</span><span style="color:#f92672">()</span>
      <span style="color:#f92672">.</span>setMaster<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;local[*]&#34;</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>setAppName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test-wordcount&#34;</span><span style="color:#f92672">)</span>
    sc <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SparkContext</span><span style="color:#f92672">(</span>sparkConf<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>

  after <span style="color:#f92672">{</span>
    sc<span style="color:#f92672">.</span>stop<span style="color:#f92672">()</span>
  <span style="color:#f92672">}</span>

  behavior of <span style="color:#e6db74">&#34;Words counter&#34;</span>

  it should <span style="color:#e6db74">&#34;count words in a text&#34;</span> in <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> text <span style="color:#66d9ef">=</span>
      <span style="color:#e6db74">&#34;&#34;&#34;Hello Spark
</span><span style="color:#e6db74">        |Hello world
</span><span style="color:#e6db74">      &#34;&#34;&#34;</span><span style="color:#f92672">.</span>stripMargin
    <span style="color:#66d9ef">val</span> lines<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>parallelize<span style="color:#f92672">(</span><span style="color:#a6e22e">List</span><span style="color:#f92672">(</span>text<span style="color:#f92672">))</span>
    <span style="color:#66d9ef">val</span> wordCounts<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">WordCounter</span><span style="color:#f92672">.</span>count<span style="color:#f92672">(</span>lines<span style="color:#f92672">)</span>

    wordCounts<span style="color:#f92672">.</span>collect<span style="color:#f92672">()</span> should contain allOf <span style="color:#f92672">((</span><span style="color:#e6db74">&#34;Hello&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Spark&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;world&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">))</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h1 id="spark-testing-base-library">Spark-testing-base library</h1>
<p>Setting up the <code>before</code> and <code>after</code> methods for all your test cases can become tedious if you have many tests. An alternative could be to hold the Context in a Singleton Object and start it once for all the tests, or to inherits a common trait to implement this behavior.</p>
<p>Also, the previous example works fine when working with a local cluster where all the data can fit in memory.
But if you are testing with a lot of data, a large sample of your production data for example, calling the <code>collect()</code> method to gather all the data locally to compare with an expected output is no longer an option.</p>
<p>Fortunately, the spark-testing-base library provides traits and methods to prepare your tests and run distributed comparisons.</p>
<p>Let’s import the library and rewrite the test:</p>
<p><code>pom.xml</code> extract:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;dependencies&gt;</span>
  <span style="color:#f92672">&lt;dependency&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.spark<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>spark-core_${scala.dep.version}<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>${spark.version}<span style="color:#f92672">&lt;/version&gt;</span>
  <span style="color:#f92672">&lt;/dependency&gt;</span>
  <span style="color:#75715e">&lt;!--spark-testing has a dependency to spark-sql, spark-hive, spark-mllib --&gt;</span>
  <span style="color:#f92672">&lt;dependency&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.spark<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>spark-sql_${scala.dep.version}<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>${spark.version}<span style="color:#f92672">&lt;/version&gt;</span>
  <span style="color:#f92672">&lt;/dependency&gt;</span>
  <span style="color:#f92672">&lt;dependency&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.spark<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>spark-hive_${scala.dep.version}<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>${spark.version}<span style="color:#f92672">&lt;/version&gt;</span>
  <span style="color:#f92672">&lt;/dependency&gt;</span>
  <span style="color:#f92672">&lt;dependency&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.spark<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>spark-mllib_${scala.dep.version}<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>${spark.version}<span style="color:#f92672">&lt;/version&gt;</span>
  <span style="color:#f92672">&lt;/dependency&gt;</span>
  <span style="color:#f92672">&lt;dependency&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>org.scalatest<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>scalatest_${scala.dep.version}<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>2.2.6<span style="color:#f92672">&lt;/version&gt;</span>
    <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
  <span style="color:#f92672">&lt;/dependency&gt;</span>
  <span style="color:#f92672">&lt;dependency&gt;</span>
    <span style="color:#f92672">&lt;groupId&gt;</span>com.holdenkarau<span style="color:#f92672">&lt;/groupId&gt;</span>
    <span style="color:#f92672">&lt;artifactId&gt;</span>spark-testing-base_${scala.dep.version}<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;version&gt;</span>${spark.version}_0.3.2-SNAPSHOT<span style="color:#f92672">&lt;/version&gt;</span>
  <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
  <span style="color:#f92672">&lt;/dependency&gt;</span>
<span style="color:#f92672">&lt;/dependencies&gt;</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">package</span> com.ipponusa
<span style="color:#66d9ef">import</span> com.holdenkarau.spark.testing.<span style="color:#f92672">{</span><span style="color:#a6e22e">RDDComparisons</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">RDDGenerator</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">SharedSparkContext</span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">import</span> org.apache.spark.rdd.RDD
<span style="color:#66d9ef">import</span> org.scalacheck.Arbitrary
<span style="color:#66d9ef">import</span> org.scalacheck.Prop._
<span style="color:#66d9ef">import</span> org.scalatest.prop.Checkers
<span style="color:#66d9ef">import</span> org.scalatest.<span style="color:#f92672">{</span><span style="color:#a6e22e">FlatSpec</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Matchers</span><span style="color:#f92672">}</span>

<span style="color:#a6e22e">@RunWith</span><span style="color:#f92672">(</span>classOf<span style="color:#f92672">[</span><span style="color:#66d9ef">JUnitRunner</span><span style="color:#f92672">])</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WordCounterWithSparkTestingTest</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">FlatSpec</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Matchers</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">SharedSparkContext</span><span style="color:#f92672">{</span>

  behavior of <span style="color:#e6db74">&#34;Words counter&#34;</span>

  it should <span style="color:#e6db74">&#34;count words in a text&#34;</span> in <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> text <span style="color:#66d9ef">=</span>
      <span style="color:#e6db74">&#34;&#34;&#34;Hello Spark
</span><span style="color:#e6db74">        |Hello world
</span><span style="color:#e6db74">      &#34;&#34;&#34;</span><span style="color:#f92672">.</span>stripMargin

    <span style="color:#66d9ef">val</span> inputRdd<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>parallelize<span style="color:#f92672">(</span><span style="color:#a6e22e">List</span><span style="color:#f92672">(</span>text<span style="color:#f92672">))</span>
    <span style="color:#66d9ef">val</span> expectedRdd<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>parallelize<span style="color:#f92672">(</span><span style="color:#a6e22e">List</span><span style="color:#f92672">((</span><span style="color:#e6db74">&#34;Hello&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Spark&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;world&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)))</span>

    <span style="color:#66d9ef">val</span> resRdd<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">RDD</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">WordCounter</span><span style="color:#f92672">.</span>count<span style="color:#f92672">(</span>inputRdd<span style="color:#f92672">)</span>
    assert<span style="color:#f92672">(</span><span style="color:#a6e22e">None</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">RDDComparisons</span><span style="color:#f92672">.</span>compare<span style="color:#f92672">(</span>resRdd<span style="color:#f92672">,</span> expectedRdd<span style="color:#f92672">))</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>The test class now extends the <code>SharedSparkContext</code> trait instead of <code>BeforeAndAfter</code>. This trait will automatically take care of starting and stopping a <code>SparkContext</code> for you.</p>
<p>The method RDDComparisons.compare(…) is more interesting.</p>
<p>Instead of locally collecting the data to be compared, the comparison will be run as RDD operations on Spark nodes. Even if this may involve a lot of shuffling operations, the data is still distributed and thus can fit in memory.</p>
<p>Of course, in the same manner, the input and expected data would not be loaded locally but most probably from external distributed storage.</p>
<p>Like HDFS for example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> inputRdd <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>textFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hdfs://127.0.0.1:9000/data/test/bigInput.txt&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">val</span> expectedRdd <span style="color:#66d9ef">=</span> sc<span style="color:#f92672">.</span>textFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hdfs://127.0.0.1:9000/data/test/bigExpected.txt&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>The spark-testing-base library also provides methods for property-based testing via an integration of the <a href="https://www.scalacheck.org/">ScalaCheck</a> library.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WordCounterWithSparkTestingTest</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">FlatSpec</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Matchers</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">SharedSparkContext</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Checkers</span> <span style="color:#f92672">{</span>

  behavior of <span style="color:#e6db74">&#34;Words counter&#34;</span>
  
  it should <span style="color:#e6db74">&#34;have stable count, with generated RDDs&#34;</span> in <span style="color:#f92672">{</span>
     <span style="color:#66d9ef">val</span> stableProperty <span style="color:#66d9ef">=</span>
       forAll<span style="color:#f92672">(</span><span style="color:#a6e22e">RDDGenerator</span><span style="color:#f92672">.</span>genRDD<span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">](</span>sc<span style="color:#f92672">)(</span><span style="color:#a6e22e">Arbitrary</span><span style="color:#f92672">.</span>arbitrary<span style="color:#f92672">[</span><span style="color:#66d9ef">String</span><span style="color:#f92672">]))</span> <span style="color:#f92672">{</span>
         rdd <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">None</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">RDDComparisons</span><span style="color:#f92672">.</span>compare<span style="color:#f92672">(</span><span style="color:#a6e22e">WordCounter</span><span style="color:#f92672">.</span>count<span style="color:#f92672">(</span>rdd<span style="color:#f92672">),</span> <span style="color:#a6e22e">WordCounter</span><span style="color:#f92672">.</span>count<span style="color:#f92672">(</span>rdd<span style="color:#f92672">))</span>
       <span style="color:#f92672">}</span>
     check<span style="color:#f92672">(</span>stableProperty<span style="color:#f92672">)</span>
   <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Here, <code>RddGenerator.genRDD[String]</code> will generate RDDs on top of random Strings.</p>
<p>We declare the property to have the same count result when executing twice the method.</p>
<p>We then test the property with the ScalaCheck method.</p>
<p>While not very relevant for the wordcount example, it allows to test your job logic against randomly generated data as input and therefore test the reliability of your code.</p>
<h1 id="conclusion">Conclusion</h1>
<p>In this article, we have seen how it is possible to refactor and test a Spark job. Testing your jobs will allow faster feedback when implementing them and you can even practice TDD.</p>
<p>The next step would be to run the tests not only on a local cluster, but on a “production-like” cluster with more data on your continuous integration server. Simply override the <code>setMaster()</code> value when configuring the <code>SparkContext</code> to redirect to your test cluster.</p>
<p>Finally, I definitely recommend you watch Holden Karau’s session on testing Spark recorded at the last Spark Summit (<a href="https://www.youtube.com/watch?v=rOQEiTXNS0g">video</a>, <a href="http://www.slideshare.net/SparkSummit/beyond-parallelize-and-collect-by-holden-karau">slides</a>).
You can find the code for these examples <a href="https://github.com/raphaelbrugier/spark-testing-example">on Github</a>.</p>
                        </div>
                        <div>
                          <a class="twitter-share-button"
                             href="https://twitter.com/intent/tweet?via=rbrugier&hashtags=Apache%20Spark,testing,"
                             data-size="large">
                          </a>
                        </div>
                        
                        
                        <div id="comments">
                            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "raphaelbrugierblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                        

                    </div>
                    

                    

                    

                    <div class="col-md-3">

                        

                        

<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
        <h3 class="panel-title">Search</h3>
    </div>

    <div class="panel-body">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" role="search">
            <div class="input-group">
                <input type="search" name="q" results="0" class="form-control" placeholder="Search">
                <input type="hidden" name="q" value="site:https://www.raphael-brugier.com/">
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>
                </span>
            </div>
        </form>
    </div>
</div>











                        

                    </div>
                    

                    

                </div>
                

            </div>
            
        </div>
        

        <footer id="footer">
    <div class="container">

        

        <div class="col-md-4 col-sm-6">

            <h4>Recent posts</h4>

            <div class="blog-entries">
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://www.raphael-brugier.com/blog/5-laws-every-developer-should-know/">
                          
                            <img src="https://www.raphael-brugier.com/img/sw-craftmanship.jpg" class="img-responsive" alt="">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://www.raphael-brugier.com/blog/5-laws-every-developer-should-know/">5 laws every developer should know</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://www.raphael-brugier.com/blog/fix-git-completion-zsh-mac-homebrew/">
                          
                            <img src="https://www.raphael-brugier.com/img/banners/git-logo.svg" class="img-responsive" alt="">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://www.raphael-brugier.com/blog/fix-git-completion-zsh-mac-homebrew/">Fix the Git completion with Oh-my-Zsh on Mac</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://www.raphael-brugier.com/til/2017-07-13-how-to-find-your-ip-with-command-line/">
                          
                            <img src="https://www.raphael-brugier.com/img/placeholder.png" class="img-responsive" alt="">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://www.raphael-brugier.com/til/2017-07-13-how-to-find-your-ip-with-command-line/">How to find your ip with command line</a></h5>
                    </div>
                </div>
                
            </div>

            <hr class="hidden-md hidden-lg">

        </div>
        

        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-right">
              Template by <a href="http://bootstrapious.com/free-templates">Bootstrapious</a>.
              

              Ported to Hugo by <a href="https://github.com/devcows/hugo-universal-theme">DevCows</a>
            </p>
        </div>
    </div>
</div>





    </div>
    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-3393491-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.5/waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>
<script src="//maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script src="https://www.raphael-brugier.com/js/hpneo.gmaps.js"></script>
<script src="https://www.raphael-brugier.com/js/gmaps.init.js"></script>
<script src="https://www.raphael-brugier.com/js/front.js"></script>


<script src="https://www.raphael-brugier.com/js/owl.carousel.min.js"></script>


  </body>
</html>
